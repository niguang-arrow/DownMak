# Computer Systems A Programmer's Perspective

## 2017 年 7 月 13 日

### 前言

+   对计算机的算术运算有深刻的理解是写出可靠程序的关键. 比如程序员和编译器不能使用表达式 `x - y < 0` 来代替 `x < y`, 因为前者可能会产生溢出. 甚至于也不能用表达式 `-y < -x` 来代替, 因为在二进制补码表表示中负数和正数的范围是不对称的.

### 第一章 计算机系统漫游

+   像 `hello.c` 这样只由 ASCII 字符构成的文件称为文本文件, 所有其他文件都称为二进制文件.

+   源程序文件 `hello.c` $\rightarrow$ 可执行目标文件 `hello`: 经历四个阶段 (预处理器, 编译器, 汇编器, 链接器)

    ```bash
       hello.c    -->   cpp    -->      hello.i       -->   cc    -->    hello.s     -->   as     -->         hello.o         -->    ld     -->         hello
    (源程序, 文本)     (预处理器)    (被修改的源程序, 文本)     (编译器)     (汇编程序, 文本)     (汇编器)     (可重定位目标程序, 二进制)  |->  (链接器)       (可执行目标程序, 二进制)
                                                                                                                           printf.o
    ```

    可以使用 `gcc -c hello.c` 产生 `hello.o` 文件, 使用 `cpp -o hello.i hello.c` 产生 `hello.i` 文件.

+   典型系统硬件组织:

    ```bash
    CPU
    ++++++++++++++++++++++++++++++++++
    |         寄存器文件               |
    |          [-----]  >>>  [     ] |
    | [ PC ]   [-----]  <<<  [ ALU ] |   系统总线           存储器总线
    |          [-----]       [     ] |  /                     |
    |             ^                  | /                      | 
    |             V                  |/                       |
    |      [ 总线接口 ] <<<---------------->>> [ I/O 桥 ] <<<--------->>> [ 主存储器 ]
    |                                |            |
    ++++++++++++++++++++++++++++++++++            |
                                                  |
    <<<---------------------------------------------------------------||-||-||-------->>>
            |            |                     I/O 总线       |       扩展槽, 留待网络适配器
    		|            |                                   |       一类的设备使用
        [USB 控制器]  [图形适配器]                          [磁盘控制器]
   ```
   
   
    +   CPU: 中央处理单元; ALU: 算术/逻辑单元; PC: 程序计数器; USB: 通用串行总线
    +   总线传送 字 (word); 字中的字节数 (称为字长) 是一个基本系统参数, 大多数机器字长有的是 4 个字节 (32位), 有的是 8 个字节 (64位).
    +   I/O 设备: 系统与外部世界联系的通道. 每个 I/O 设备都通过一个控制器或适配器与 I/O 总线相连. 控制器和适配器之间的区别主要是在于它们的封装方式: 控制器是置于 I/O 设备本身的或者系统的主板上的芯片组, 而适配器则是一块插在主板插槽上的卡. 它们的功能都是在 I/O 总线和 I/O 设备之间传递信息.
    +   主存: 临时存储设备, 在处理器执行程序时, 用来存放程序和程序处理的数据.
    +   CPU: 处理器的核心是一个字长的存储设备(或寄存器), 称为程序计数器 (PC). 在任何时刻, PC 都指向主存中的某条机器语言指令 (即含有该条指令的地址)
        +   寄存器文件 (register file) 是一个小的存储设备, 由一些 1 字长的寄存器组成. 每个寄存器都有唯一的名字
        +   ALU 计算新的数据和地址值
    +   利用直接存储器存取 (DMA) 技术, 数据可以不通过处理器而直接从磁盘到达主存.
    +   一旦目标文件 hello 中的代码和数据被加载到主存中, 处理器就开始执行 hello 程序的 main 程序中的机器语言指令. 这些指令将 "hello, world\n" 字符串中的字节从主存复制到寄存器文件, 再从寄存器文件中复制到显示设备, 最终显示在屏幕上.

+   高速缓存至关重要: 根据机械原理, 较大的存储设备要比较小的存储设备运行得慢, 而快速设备的造价远高于同类的低速设备. 处理器从寄存器文件中读数据的速度比从主存中读取几乎快 100 倍 (寄存器文件只存储几百字节的信息, 而主存里可以存放几十亿字节). 使用高速缓存存储器可以用来存放处理器近期可能会需要的信息. 位于处理器芯片上的 L1 高速缓存的容量可以达到数万字节, 访问速度几乎和访问寄存器文件一样快. 可以利用高速缓存将程序的性能提高一个数量级.

+   存储设备形成层次结构: (从上向下, 设备的访问速度越来越慢, 容量越来越大, 并且每个字节的造价页越来越便宜)

    ```bash
                	 _______________
                L0: /     寄存器     \
                   /_________________\
              L1: / L1 高速缓存 (SRAM) \
                 /_____________________\ 
            L2: /   L2 高速缓存 (SRAM)   \
               /________________________\
          L3: /     L3 高速缓存 (SRAM)    \
             /___________________________\
    	L4: /          主存 (DRAM)        \
           /______________________________\
      L5: /       本地二级存储 (本地磁盘)     \
         /_________________________________\
    L6: /             远程二级存储           \
       /      (分布式文件系统, Web 服务器)     \
      /_____________________________________\
    ```

    +   存储器层次结构的主要思想是: 一层上的存储器作为第一层存储器的高速缓存.

+   计算机系统的分层视图:

    ```bash
    ___________________________________
    [             应用程序              ]
    [             操作系统              ]
    [ 处理器 ]-----[ 主存 ]----[ I/O 设备]
    ```

+   操作系统提供的抽象表示

    ```bash
    [ 处理器 ]-----[ 主存 ]----[ I/O 设备]
                              +++++++++
                                 文件
                  +++++++++++++++++++++
                        虚拟存储器
    +++++++++++++++++++++++++++++++++++
                  进程            
    ```

    +   操作系统的两个基本功能:
        +   防止硬件被失控的应用程序滥用
        +   向应用程序提供简单一致的机制来控制复杂而又通常大相径庭的低级硬件设备
        +   操作系统通过进程, 虚拟存储器和文件几个抽象的概念来实现这两个功能.

+   虚拟存储器

+   系统之间利用网络通信: 网络也可以视为一个 I/O 设备.

### 第二章 信息的表示和处理

















